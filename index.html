<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>éŠæˆ²ç‹€æ…‹ç›£æ§</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
  /* ä¸å…è¨±æ»¾å‹• */
  html,body { height:100%; margin:0; padding:0; overflow:hidden; font-family: "Segoe UI", Roboto, "Noto Sans TC", system-ui, -apple-system; background: #0f1115; color:#e6eef1; }

  /* ä¸­å¤®å¡ç‰‡ */
  .wrap {
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
    box-sizing:border-box;
  }
  .card {
    width:100%;
    max-width:520px;
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    border-radius:16px;
    padding:28px;
    box-shadow: 0 10px 30px rgba(2,6,23,0.7), inset 0 1px 0 rgba(255,255,255,0.02);
    backdrop-filter: blur(8px);
    text-align:center;
  }

  h1 {
    margin:0 0 12px 0;
    font-weight:600;
    color:#f5fbff;
    font-size:1.6rem;
    letter-spacing:0.4px;
  }

  .status-row {
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    margin-top:10px;
  }

  .dot {
    width:14px; height:14px; border-radius:50%;
    box-shadow: 0 4px 12px rgba(2,6,23,0.6);
    transition: transform .18s ease, box-shadow .18s ease;
  }
  .dot.off { background: #b84a4a; transform: scale(1); box-shadow:0 6px 18px rgba(184,74,74,0.18); }
  .dot.on  { background: #2fe3b6; transform: scale(1.06); box-shadow:0 10px 26px rgba(47,227,182,0.18); }

  .state-text { font-size:1.05rem; color:#dffbf3; }
  .game-name { margin-top:8px; font-size:1.25rem; color:#c9fff0; font-weight:700; }

  .timer {
    margin-top:12px;
    font-size:1.05rem;
    color:#f0f7f3;
    opacity:0.95;
  }

  .controls { margin-top:20px; display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap; }
  .btn {
    -webkit-tap-highlight-color: transparent;
    background: linear-gradient(90deg,#ffb86b 0%, #ffde7a 100%);
    border: none;
    color: #0b1012;
    padding:12px 20px;
    border-radius:10px;
    font-weight:600;
    cursor:pointer;
    box-shadow: 0 8px 20px rgba(10,14,18,0.45);
    transition: transform .12s ease, box-shadow .12s ease, opacity .12s;
  }
  .btn:active { transform: translateY(1px) scale(.998); }
  .btn.secondary {
    background: transparent;
    color:#bcd8d0;
    border:1px solid rgba(255,255,255,0.04);
    box-shadow:none;
  }

  /* å°å­— */
  .muted { margin-top:10px; font-size:0.85rem; color: #9fb2ac; opacity:0.9; }

  @media (max-width:420px) {
    .card { padding:20px; border-radius:14px; }
    h1 { font-size:1.35rem; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-live="polite">
      <h1>éŠæˆ²ç‹€æ…‹ç›£æ§</h1>

      <div class="status-row" aria-hidden="false">
        <span id="dot" class="dot off" aria-hidden="true"></span>
        <div>
          <div id="stateText" class="state-text">è®€å–ä¸­â€¦</div>
          <div id="gameName" class="game-name"></div>
        </div>
      </div>

      <div id="timer" class="timer" aria-live="polite"></div>

      <div class="controls">
        <button id="inviteBtn" class="btn">ğŸ‰ é‚€è«‹ä¸Šç·š</button>
        <button id="refreshBtn" class="btn secondary" title="æ‰‹å‹•é‡æ•´ç‹€æ…‹">é‡æ–°æ•´ç†</button>
      </div>

      <div class="muted">æŒ‰ä¸‹ã€Œé‚€è«‹ä¸Šç·šã€å¾Œï¼ŒAutomate æœƒåµæ¸¬ & ç™¼é€é€šçŸ¥ã€‚</div>
    </div>
  </div>

<script>
  // Firebase config â€” ä¿æŒä½ åŸæœ¬çš„
  const firebaseConfig = {
    apiKey: "AIzaSyDrcsNwolJ33wYPtgHBFbQMHTpNVcgSngs",
    authDomain: "nova-game-status.firebaseapp.com",
    databaseURL: "https://nova-game-status-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "nova-game-status",
    storageBucket: "nova-game-status.firebasestorage.app",
    messagingSenderId: "441392361547",
    appId: "1:441392361547:web:8ba275c3caae6033499dce",
    measurementId: "G-J8QD6GXYL8"
  };

  // åˆå§‹åŒ– firebase (compat)
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // UI å…ƒä»¶
  const dot = document.getElementById('dot');
  const stateText = document.getElementById('stateText');
  const gameName = document.getElementById('gameName');
  const timerEl = document.getElementById('timer');
  const inviteBtn = document.getElementById('inviteBtn');
  const refreshBtn = document.getElementById('refreshBtn');

  let timerInterval = null;

  // å°‡å„ç¨®å¯èƒ½å›å‚³å€¼ (true/"true"/1/"1") åˆ¤ä½œä¸Šç·š
  function isTruthy(val) {
    return val === true || val === 1 || val === "1" || val === "true";
  }

  function setOnlineUI(game) {
    dot.classList.remove('off'); dot.classList.add('on');
    stateText.textContent = 'ä¸Šç·šä¸­';
    gameName.textContent = game || '';
  }
  function setOfflineUI() {
    dot.classList.remove('on'); dot.classList.add('off');
    stateText.textContent = 'æœªä¸Šç·š';
    gameName.textContent = '';
    timerEl.textContent = '';
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  }

  // æ›´æ–°è¨ˆæ™‚å™¨ï¼šæ”¯æ´ status.startTime (ç‰©ä»¶) æˆ– single startTime value
  function startTimerFromStartTime(rawStart) {
    if (!rawStart) {
      timerEl.textContent = '';
      return;
    }
    // rawStart å¯èƒ½æ˜¯ç§’æˆ–æ¯«ç§’ -> ä¿éšªè½‰æˆæ¯«ç§’
    const startMs = (rawStart > 1e12) ? rawStart : rawStart * 1000;
    function tick() {
      const diff = Date.now() - startMs;
      if (diff < 0) {
        timerEl.textContent = '';
        return;
      }
      const totalSec = Math.floor(diff / 1000);
      const hh = String(Math.floor(totalSec / 3600)).padStart(2,'0');
      const mm = String(Math.floor((totalSec % 3600) / 60)).padStart(2,'0');
      const ss = String(totalSec % 60).padStart(2,'0');
      timerEl.textContent = `â± æœ¬æ¬¡éŠæˆ²æ™‚é–“ ${hh}:${mm}:${ss}`;
    }
    if (timerInterval) clearInterval(timerInterval);
    tick();
    timerInterval = setInterval(tick, 1000);
  }

  // é è¨­ï¼šå…ˆé¡¯ç¤ºæœªä¸Šç·š
  setOfflineUI();

  // ç›£è½å…©ç¨®å¸¸è¦‹å¯«æ³•ï¼š
  // 1) /status ç¯€é»ï¼ˆç‰©ä»¶ï¼Œå« playing, game, startTimeï¼‰
  // 2) /playing ç¯€é»ï¼ˆå–®ä¸€å€¼ï¼‰
  const statusRef = db.ref('status');
  const playingRef = db.ref('playing');

  // ç•¶ status ç¯€é»æ›´æ–°æ™‚ä»¥ status ç‚ºä¸»
  statusRef.on('value', snap => {
    const data = snap.val();
    if (!data) {
      // å¦‚æœæ²’æœ‰ status ç¯€é»ï¼Œä¸å¼·è¡Œè¨­ç‚ºæœªä¸Šç·šï¼Œè®“ playingRef æ±ºå®š
      return;
    }
    const playing = data.playing;
    if (isTruthy(playing)) {
      setOnlineUI(data.game || '');
      startTimerFromStartTime(data.startTime || data.start || 0);
    } else {
      setOfflineUI();
    }
  }, err => {
    console.warn('statusRef error', err);
  });

  // ç•¶ playing ç¯€é»æ›´æ–°æ™‚ï¼ˆè‹¥ status æ²’æä¾›å‰‡ä»¥ playing æ±ºå®šï¼‰
  playingRef.on('value', snap => {
    const val = snap.val();
    // è‹¥ status å­˜åœ¨ä¸”æœ‰ playing å±¬æ€§ï¼Œstatus listener å·²è™•ç†å„ªå…ˆ
    db.ref('status').once('value').then(snapStatus => {
      const st = snapStatus.val();
      if (st && typeof st.playing !== 'undefined') {
        // status å·²ç¶“æœ‰è³‡æ–™ => å¿½ç•¥å–®ä¸€ playing çš„è¦†è“‹
        return;
      }
      if (isTruthy(val)) {
        // æ²’æœ‰ç´°ç¯€æ™‚åªé¡¯ç¤ºä¸Šç·šï¼Œåç¨±ç©ºç™½
        setOnlineUI('');
        // ç„¡ startTime å¯ç”¨
        timerEl.textContent = '';
      } else {
        setOfflineUI();
      }
    }).catch(()=>{ /* ignore */ });
  });

  // invite æŒ‰éˆ•ï¼šæŠŠ inviteRequest è¨­ç‚º trueï¼ˆä¸åšè‡ªå‹•é‡ç½®ï¼‰
  inviteBtn.addEventListener('click', () => {
    inviteBtn.disabled = true;
    const inviteRef = db.ref('inviteRequest');
    inviteRef.set(true)
      .then(() => {
        // çŸ­æš«æç¤º
        inviteBtn.textContent = 'å·²ç™¼é€ âœ“';
        setTimeout(()=>{ inviteBtn.textContent = 'ğŸ‰ é‚€è«‹ä¸Šç·š'; inviteBtn.disabled = false; }, 1200);
      })
      .catch(err => {
        alert('ç™¼é€å¤±æ•—ï¼š' + (err && err.message ? err.message : err));
        inviteBtn.disabled = false;
      });
  });

  // æ‰‹å‹•åˆ·æ–°ï¼ˆdebug / å¼·åˆ¶é‡æ–°æŠ“ï¼‰
  refreshBtn.addEventListener('click', () => {
    // å¼·åˆ¶è®€ä¸€æ¬¡ status / playing
    Promise.all([ db.ref('status').once('value'), db.ref('playing').once('value') ])
      .then(([s,p])=>{
        // æœƒç”±ä¸Šé¢çš„ listener è‡ªå‹•æ›´æ–° UI
        // åªæ˜¯å¿«é€Ÿæç¤ºä½¿ç”¨è€…
        const sd = s.val(), pd = p.val();
        console.log('refresh status', sd, 'playing', pd);
      }).catch(e=>console.warn(e));
  });

  // optional: é˜²æ­¢é é¢è¢«ç³»çµ±æ‰‹å‹¢èª¤æ»‘å‹•ï¼ˆåœ¨ä¸€äº› Android Webview æœ‰ç”¨ï¼‰
  window.addEventListener('touchmove', function(e){ e.preventDefault(); }, { passive: false });
</script>
</body>
</html>