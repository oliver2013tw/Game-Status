<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>éŠæˆ²ç‹€æ…‹ç›£æ§</title>
<style>
html, body {
  margin:0;
  padding:0;
  height:100%;
  overflow:hidden;
  font-family: "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
  background: linear-gradient(135deg, #0f172a, #1e293b);
  color:white;
}

.wrapper {
  height:100%;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:40px;
  box-sizing:border-box;
}

.card {
  width:100%;
  max-width:500px;
  background:#1e293b;
  border-radius:20px;
  padding:40px;
  box-shadow:0 15px 40px rgba(0,0,0,0.6);
  text-align:center;
}

h1 {
  margin-top:0;
  font-size:1.8rem;
  font-weight:700;
  margin-bottom:25px;
}

.status-text {
  font-size:1.2rem;
  margin-bottom:15px;
}

.status-text .online { color:#22c55e; }
.status-text .offline { color:#ef4444; }

#gameName {
  font-size:22px;
  margin-bottom:10px;
  font-weight:600;
}

#playTime {
  font-size:18px;
  color:#38bdf8;
  margin-bottom:20px;
}

button {
  padding:14px 28px;
  font-size:1rem;
  border-radius:12px;
  border:none;
  cursor:pointer;
  background:#facc15;
  color:#1e293b;
  font-weight:700;
  transition:0.2s;
}

button:hover { opacity:0.9; }

button:disabled {
  background:#64748b;
  cursor:not-allowed;
  color:#e2e8f0;
}
</style>
</head>
<body>

<div class="wrapper">
  <div class="card">
    <h1>éŠæˆ²ç‹€æ…‹ç›£æ§</h1>
    <div class="status-text">
      ç‹€æ…‹ï¼š<span id="statusText" class="offline">è¼‰å…¥ä¸­...</span>
    </div>
    <div id="gameName">éŠæˆ²åç¨±è¼‰å…¥ä¸­...</div>
    <div id="playTime"></div>
    <button id="inviteBtn">ğŸ‰ é‚€è«‹ä¸Šç·š</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* ğŸ”¹ ä½ çš„ Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyDrcsNwolJ33wYPtgHBFbQMHTpNVcgSngs",
  authDomain: "nova-game-status.firebaseapp.com",
  databaseURL: "https://nova-game-status-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nova-game-status",
  storageBucket: "nova-game-status.firebasestorage.app",
  messagingSenderId: "441392361547",
  appId: "1:441392361547:web:8ba275c3caae6033499dce"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* å…ƒä»¶ */
const statusText = document.getElementById("statusText");
const gameName = document.getElementById("gameName");
const playTime = document.getElementById("playTime");
const inviteBtn = document.getElementById("inviteBtn");

let timerInterval = null;

const statusRef = ref(db,"/"); // æ ¹ç›®éŒ„ game / playing / startTime

function isPlaying(val){ return val==1 || val===true || val==="1" || val==="true"; }

onValue(statusRef,(snapshot)=>{
  const data = snapshot.val();
  if(!data) return;

  if(isPlaying(data.playing)){
    statusText.textContent = "ä¸Šç·šä¸­";
    statusText.className = "online";

    gameName.textContent = data.game || "æœªçŸ¥éŠæˆ²";

    if(timerInterval) clearInterval(timerInterval);

    if(data.startTime){
      timerInterval = setInterval(()=>{
        const diff = Date.now() - Number(data.startTime);
        const h = Math.floor(diff/3600000);
        const m = Math.floor((diff%3600000)/60000);
        const s = Math.floor((diff%60000)/1000);
        playTime.textContent = `${h}å°æ™‚ ${m}åˆ† ${s}ç§’`;
      },1000);
    }

  } else {
    statusText.textContent = "æœªä¸Šç·š";
    statusText.className = "offline";
    gameName.textContent = "æœªåœ¨éŠç©";
    playTime.textContent = "";
    if(timerInterval) clearInterval(timerInterval);
  }
});

/* é‚€è«‹ä¸Šç·š 10 åˆ†é˜å†·å» */
const COOLDOWN = 10*60*1000;
function updateCooldown(){
  const last = localStorage.getItem("inviteLastTime");
  if(!last) return;

  const remain = COOLDOWN - (Date.now() - Number(last));
  if(remain>0){
    inviteBtn.disabled=true;
    const m = Math.floor(remain/60000);
    const s = Math.floor((remain%60000)/1000);
    inviteBtn.textContent = `è«‹ç­‰å¾… ${m}:${String(s).padStart(2,'0')}`;
    setTimeout(updateCooldown,1000);
  }else{
    inviteBtn.disabled=false;
    inviteBtn.textContent="ğŸ‰ é‚€è«‹ä¸Šç·š";
    localStorage.removeItem("inviteLastTime");
  }
}

inviteBtn.addEventListener("click",()=>{
  const last = localStorage.getItem("inviteLastTime");
  if(last && Date.now()-Number(last)<COOLDOWN) return;

  inviteBtn.disabled=true;

  set(ref(db,"inviteRequest"),true)
    .then(()=>{
      localStorage.setItem("inviteLastTime",Date.now().toString());
      updateCooldown();
    })
    .catch(err=>{
      alert("ç™¼é€å¤±æ•—ï¼š"+err);
      inviteBtn.disabled=false;
    });
});

updateCooldown();
</script>
</body>
</html>